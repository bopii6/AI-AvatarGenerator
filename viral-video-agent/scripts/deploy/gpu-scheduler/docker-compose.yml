version: '3.8'

services:
  gpu-scheduler:
    container_name: gpu-scheduler
    image: python:3.11-slim
    restart: unless-stopped
    # 旧版 Docker 环境下，host-gateway/host.docker.internal 可能不可用；
    # 使用 host 网络可直接访问宿主机的 9090/8383，同时对外提供 9999。
    network_mode: host
    working_dir: /app
    volumes:
      # 挂载 Docker Socket，允许调度器控制其他容器
      - /var/run/docker.sock:/var/run/docker.sock
      # 仅挂载调度器目录：更新文件后重启容器即可
      - /root/viral-video-agent/scripts/deploy/gpu-scheduler:/app
      # pip 缓存加速（可选）
      - /root/.cache/pip:/root/.cache/pip
    environment:
      - GPU_API_KEY=p7CENXBfckQsYV5rdwKRqaoTDP29ie3H
      - COSYVOICE_DIR=/root/viral-video-agent/scripts/deploy/cosyvoice
      - DUIX_DIR=/root/viral-video-agent/scripts/deploy/duix
      - COSYVOICE_URL=http://127.0.0.1:9090
      - DUIX_URL=http://127.0.0.1:8383
      - SERVICE_SWITCH_TIMEOUT=120
      - PIP_INDEX_URL=https://mirrors.aliyun.com/pypi/simple
      - PIP_DISABLE_PIP_VERSION_CHECK=1
    command: >
      /bin/bash -lc
      "python -c 'import fastapi,uvicorn,httpx,docker' 2>/dev/null
      || pip install fastapi uvicorn httpx docker;
      python /app/scheduler.py"
